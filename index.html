<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IPTV Smart List</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: #fff; margin: 0; padding: 20px; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #444; background: #222; color: #fff; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #searchBar { background: #333; border: 1px solid #007bff; display: none; margin-top: 10px; }
        .section-title { font-size: 14px; color: #007bff; margin: 15px 5px 5px; font-weight: bold; }
        .item { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; background: #111; margin-bottom: 5px; border-radius: 8px; }
        .item-info { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .fav-star { font-size: 20px; margin-left: 15px; cursor: pointer; color: #444; transition: 0.2s; }
        .fav-star.active { color: #ffcc00; }
        .vlc-btn { background: #ff8800; color: #000; padding: 6px 12px; border-radius: 6px; font-weight: bold; font-size: 12px; white-space: nowrap; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="margin-top:0;">×”×˜×œ×•×•×™×–×™×” ×©×œ×™</h2>
    <input type="text" id="m3uUrl" placeholder="×”×“×‘×§ ×§×™×©×•×¨ M3U">
    <button onclick="loadList()">×˜×¢×Ÿ ×¢×¨×•×¦×™×</button>
    <input type="text" id="searchBar" placeholder="×—×¤×© ×¢×¨×•×¥..." onkeyup="filterChannels()">
</div>

<div id="favoritesSection" style="display:none;">
    <div class="section-title">â­ ×¢×¨×•×¦×™× ××•×¢×“×¤×™×</div>
    <div id="favList"></div>
</div>

<div id="allSection">
    <div class="section-title" id="allTitle">ğŸ“º ×›×œ ×”×¢×¨×•×¦×™×</div>
    <div id="list"></div>
</div>

<script>
    const proxy = "https://crimson-shape-c77d.evgeni3-1db.workers.dev/";
    let allChannels = [];
    let favorites = JSON.parse(localStorage.getItem('iptv_favs')) || [];

    async function loadList() {
        const m3u = document.getElementById('m3uUrl').value.trim();
        if(!m3u) return;
        localStorage.setItem('iptv_vlc_link', m3u);
        const listDiv = document.getElementById('list');
        listDiv.innerHTML = "×˜×•×¢×Ÿ ×¨×©×™××”...";
        
        try {
            const res = await fetch(`${proxy}?url=${encodeURIComponent(m3u)}`);
            const text = await res.text();
            const lines = text.split('\n');
            allChannels = [];
            let currentName = "";
            
            lines.forEach(line => {
                if (line.startsWith('#EXTINF:')) currentName = line.split(',').pop().trim();
                else if (line.startsWith('http')) {
                    allChannels.push({ name: currentName || "×¢×¨×•×¥ ×›×œ×œ×™", url: line.trim() });
                    currentName = "";
                }
            });
            
            document.getElementById('searchBar').style.display = "block";
            render();
        } catch (e) { listDiv.innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×”."; }
    }

    function toggleFav(name, url, event) {
        event.stopPropagation();
        const index = favorites.findIndex(f => f.url === url);
        if (index > -1) favorites.splice(index, 1);
        else favorites.push({ name, url });
        
        localStorage.setItem('iptv_favs', JSON.stringify(favorites));
        render();
    }

    function render(filtered = null) {
        const listDiv = document.getElementById('list');
        const favDiv = document.getElementById('favList');
        const favSection = document.getElementById('favoritesSection');
        const channelsToDisplay = filtered || allChannels;

        // ×¨×™× ×“×•×¨ ××•×¢×“×¤×™×
        favDiv.innerHTML = '';
        if (favorites.length > 0 && !filtered) {
            favSection.style.display = "block";
            favorites.forEach(ch => favDiv.appendChild(createItem(ch, true)));
        } else {
            favSection.style.display = "none";
        }

        // ×¨×™× ×“×•×¨ ×›×œ ×”×©××¨
        listDiv.innerHTML = '';
        channelsToDisplay.forEach(ch => {
            const isFav = favorites.some(f => f.url === ch.url);
            listDiv.appendChild(createItem(ch, isFav));
        });
    }

    function createItem(ch, isFav) {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
            <div class="item-info" onclick="openVLC('${ch.url}')">
                <span class="fav-star ${isFav ? 'active' : ''}" onclick="toggleFav('${ch.name}', '${ch.url}', event)">â˜…</span>
                <span>${ch.name}</span>
            </div>
            <div class="vlc-btn" onclick="openVLC('${ch.url}')">×¦×¤×”</div>
        `;
        return div;
    }

    function openVLC(url) {
        window.location.href = `vlc-x-callback://x-callback-url/stream?url=${encodeURIComponent(url)}`;
    }

    function filterChannels() {
        const query = document.getElementById('searchBar').value.toLowerCase();
        if (!query) return render();
        const filtered = allChannels.filter(ch => ch.name.toLowerCase().includes(query));
        render(filtered);
    }

    window.onload = () => {
        const saved = localStorage.getItem('iptv_vlc_link');
        if(saved) { document.getElementById('m3uUrl').value = saved; loadList(); }
    };
</script>
</body>
</html>

</body>
</html>
